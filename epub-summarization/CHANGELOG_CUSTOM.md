# EPUB Summarization 開發日誌

## 2026-01-11 進度記錄

### 已完成功能

1. **EPUB 解析與內容提取**
   - 支援 EPUB 3 (nav) 和 EPUB 2 (NCX) 目錄結構
   - 實作 spine-based 內容提取，處理章節內容跨多個檔案的情況
   - 支援 TOC 指向圖片檔而實際文字在後續檔案的 EPUB 結構

2. **兩種摘要策略**
   - Map Reduce: 先為每章生成摘要，再合併成全書摘要
   - Refine: 逐章精煉摘要，最終產生全書摘要

3. **輸出格式**
   - 輸出檔名: `[epub檔名]-[mapreduce|refine].md`
   - 輸出位置: 與 EPUB 檔案相同目錄

---

## 摘要策略參數

### Map Reduce 策略

#### 章節摘要 (summarize_chapter)
```
位置: llm.py:62-75
長度要求: 150-300 字

prompt 內容:
請為以下章節內容撰寫摘要。

章節標題：{title}

要求：
- 使用{language}撰寫
- 摘要長度約 150-300 字
- 抓取章節的核心概念和重點
- 保持客觀、簡潔的風格

章節內容：
{content}

請直接輸出摘要內容，不需要任何前綴或標題。
```

#### 全書摘要 (summarize_book)
```
位置: llm.py:96-110
長度要求: 500-800 字 (2026-01-11 更新，原為 300-500 字)

prompt 內容:
請根據以下各章節摘要，為整本書撰寫綜合摘要。

書名：{book_title}

要求：
- 使用{language}撰寫
- 摘要長度約 500-800 字
- 綜合全書的主旨、核心論點和結論
- 呈現書籍的整體架構和邏輯脈絡
- 保持客觀、學術的風格

各章節摘要：
{chapter_summaries}

請直接輸出全書摘要內容，不需要任何前綴或標題。
```

---

### Refine 策略

#### 初始摘要 (第一章)
```
位置: llm.py:161-175
長度要求: 200-400 字

prompt 內容:
請為以下書籍的第一個章節撰寫初始摘要。

書名：{book_title}
章節 {chapter_index}/{total_chapters}：{new_title}

要求：
- 使用{language}撰寫
- 摘要長度約 200-400 字
- 抓取章節的核心概念和重點
- 這是全書摘要的起點，後續會逐章精煉

章節內容：
{new_content}

請直接輸出摘要內容，不需要任何前綴或標題。
```

#### 精煉摘要 (後續章節)
```
位置: llm.py:177-198
長度要求: 動態計算 min(300 + chapter_index * 50, 800) 字

prompt 內容:
請根據新的章節內容，精煉並擴充現有的書籍摘要。

書名：{book_title}
目前進度：章節 {chapter_index}/{total_chapters}
新章節標題：{new_title}

現有摘要：
{existing_summary}

新章節內容：
{new_content}

要求：
- 使用{language}撰寫
- 將新章節的重點整合到現有摘要中
- 保持摘要的連貫性和邏輯流暢
- 摘要長度可隨內容增加適度擴展（目前建議 {suggested_length} 字左右）
- 避免重複，突出新增的核心概念
- 保持客觀、學術的風格

請直接輸出精煉後的完整摘要，不需要任何前綴或標題。
```

#### 最終整理 (finalize_refined_summary)
```
位置: llm.py:219-234
長度要求: 500-800 字

prompt 內容:
請將以下逐章精煉的書籍摘要進行最終整理和潤飾。

書名：{book_title}

逐章精煉摘要：
{refined_summary}

要求：
- 使用{language}撰寫
- 確保結構完整、邏輯清晰
- 摘要長度約 500-800 字
- 涵蓋全書的主旨、核心論點、主要方法和結論
- 保持客觀、學術的風格
- 適當分段以提高可讀性

請直接輸出最終摘要，不需要任何前綴或標題。
```

---

## 測試結果 (2026-01-11)

測試 EPUB 檔案: 178998.epub, 318347.epub, 362484.epub, 424489.epub

### 輸出檔案大小

| 檔案 | Map Reduce | Refine |
|------|------------|--------|
| 178998 | 50KB | 2.8KB |
| 318347 | 54KB | 2.7KB |
| 362484 | 67KB | 2.5KB |
| 424489 | 34KB | 2.7KB |

**說明:**
- Map Reduce 檔案較大是因為包含所有章節摘要
- Refine 檔案僅包含全書摘要

### 全書摘要長度比較 (2026-01-11 更新後)

將 Map Reduce 全書摘要長度要求從 300-500 字調整為 500-800 字後的測試結果：

| 檔案 | Map Reduce | Refine |
|------|------------|--------|
| 178998 (原子習慣) | 2,652 字元 | 2,734 字元 |
| 318347 (我可能錯了) | 2,620 字元 | 2,628 字元 |
| 362484 (納瓦爾寶典) | 2,667 字元 | 2,339 字元 |
| 424489 (世界盡頭的咖啡館) | 2,728 字元 | 2,630 字元 |

**說明:**
- 兩種策略現在產生相近長度的全書摘要
- 實際輸出長度（約 2,300-2,700 字元）超過 prompt 要求的 500-800 字
- LLM 傾向產生比指定長度更多的內容

---

## 兩種策略的比較

### 流程差異

**Map Reduce 策略流程：**
```
章節1 ──→ LLM ──→ 摘要1 ─┐
章節2 ──→ LLM ──→ 摘要2 ─┼──→ LLM ──→ 全書摘要
章節3 ──→ LLM ──→ 摘要3 ─┤
  ...                    │
章節N ──→ LLM ──→ 摘要N ─┘
```
- 每個章節獨立處理，可平行執行
- 最後合併所有章節摘要，產生全書摘要

**Refine 策略流程：**
```
章節1 ──────────────────────→ LLM ──→ 摘要v1
                                        ↓
章節2 + 摘要v1 ─────────────→ LLM ──→ 摘要v2
                                        ↓
章節3 + 摘要v2 ─────────────→ LLM ──→ 摘要v3
                                        ↓
  ...                                   ↓
                                        ↓
章節N + 摘要v(N-1) ─────────→ LLM ──→ 摘要vN
                                        ↓
                             LLM ──→ 全書摘要（最終整理）
```
- 逐章迭代處理，每次都帶入現有摘要
- 摘要隨章節推進而逐步精煉

---

### 技術比較

| 項目 | Map Reduce | Refine |
|------|------------|--------|
| **每次 LLM 呼叫輸入** | 單一章節內容 | 現有摘要 + 新章節內容 |
| **章節摘要長度** | 固定 150-300 字 | 動態：min(300 + index*50, 800) 字 |
| **內容截斷限制** | 300,000 字元/章節 | 200,000 字元/章節 |
| **章節間關聯** | 無（獨立處理） | 有（摘要累積脈絡） |
| **LLM 呼叫次數** | N+1 次（N章節 + 1全書） | N+1 次（N章節 + 1整理） |
| **可否平行處理** | 章節摘要可平行 | 必須循序處理 |
| **最終輸出** | 各章摘要 + 全書摘要 | 僅全書摘要 |

---

### 優缺點比較

#### Map Reduce

**優點：**
- 章節處理可平行化，速度較快
- 保留各章節獨立摘要，方便查閱特定章節
- 章節間不會互相干擾，適合內容獨立性高的書籍

**缺點：**
- 各章節摘要獨立產生，可能遺失章節間的邏輯連貫性
- 全書摘要是基於摘要的摘要，可能損失細節
- 輸出檔案較大（包含所有章節摘要）

#### Refine

**優點：**
- 摘要隨閱讀推進而精煉，保持整體連貫性
- 後面章節可參考前面的脈絡，產生更一致的敘事
- 輸出檔案精簡（僅全書摘要）

**缺點：**
- 必須循序處理，無法平行化，速度較慢
- 不保留各章節獨立摘要
- 後期章節的摘要可能被壓縮，早期內容佔比較高

---

### 使用建議

| 情境 | 建議策略 |
|------|----------|
| 想快速瀏覽各章節重點 | Map Reduce |
| 追求整體敘事連貫性 | Refine |
| 書籍各章獨立性高（如工具書、食譜） | Map Reduce |
| 書籍前後章節關聯緊密（如小說、論述） | Refine |
| 需要平行處理以加速 | Map Reduce |
| 只需要全書摘要，不需各章細節 | Refine |

---

## 變更記錄

### 2026-01-11
- [x] 將 Map Reduce 全書摘要長度要求從 300-500 字調整為 500-800 字（與 Refine 策略一致）
  - 修改位置: `llm.py:102`

---

## 待優化項目

- [x] ~~全書摘要長度可能過短，考慮調整 prompt 參數~~ (已完成)
- [ ] 考慮調整 prompt 以控制實際輸出長度更接近指定範圍
